image: terrestris/gitlab-runner-image:6.2.2.36-3

stages:
  - deploy

deploy-internal:
  stage: deploy
  environment:
    name: internal
  only:
    - internal_deploy@terrestris/shogun-docker
  when: manual
  tags: ['intranet']
  script:
    # Run ssh-agent (inside the build environment)
    - eval $(ssh-agent -s)
    # Add the SSH key stored in $SSH_PRIVATE_KEY_INTERNAL variable to the agent store
    - echo "$SSH_PRIVATE_KEY_INTERNAL" | ssh-add -
    # For Docker builds disable host key checking. Be aware that by adding that
    # you are suspectible to man-in-the-middle attacks.
    # WARNING: Use this only with the Docker executor, if you use it with shell
    # you will overwrite your user's SSH config.
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
    - ssh $DEPLOY_SSH_USER_INTERNAL@$DEPLOY_SSH_HOST_INTERNAL mkdir -p /home/$DEPLOY_SSH_USER_INTERNAL/shogun
    - scp docker-compose-prod.yml $DEPLOY_SSH_USER_INTERNAL@$DEPLOY_SSH_HOST_INTERNAL:/home/$DEPLOY_SSH_USER_INTERNAL/shogun/docker-compose.yml
    - scp common-services.yml $DEPLOY_SSH_USER_INTERNAL@$DEPLOY_SSH_HOST_INTERNAL:/home/$DEPLOY_SSH_USER_INTERNAL/shogun/common-services.yml
    - ssh $DEPLOY_SSH_USER_INTERNAL@$DEPLOY_SSH_HOST_INTERNAL docker login -u $NEXUS_USER -p $NEXUS_PASSWORD nexus.terrestris.de
    - ssh $DEPLOY_SSH_USER_INTERNAL@$DEPLOY_SSH_HOST_INTERNAL docker system prune -f
    - ssh $DEPLOY_SSH_USER_INTERNAL@$DEPLOY_SSH_HOST_INTERNAL docker compose --file /home/$DEPLOY_SSH_USER_INTERNAL/shogun/docker-compose.yml down
    - rsync -avh --exclude '.git' shogun-admin -e ssh $DEPLOY_SSH_USER_INTERNAL@$DEPLOY_SSH_HOST_INTERNAL:/home/$DEPLOY_SSH_USER_INTERNAL/shogun --progress
    - rsync -avh --exclude '.git' shogun-boot -e ssh $DEPLOY_SSH_USER_INTERNAL@$DEPLOY_SSH_HOST_INTERNAL:/home/$DEPLOY_SSH_USER_INTERNAL/shogun --progress
    - rsync -avh --exclude '.git' shogun-client -e ssh $DEPLOY_SSH_USER_INTERNAL@$DEPLOY_SSH_HOST_INTERNAL:/home/$DEPLOY_SSH_USER_INTERNAL/shogun --progress
    - rsync -avh --exclude={'.git','Dockerfile','geoserver_data'} shogun-geoserver -e ssh $DEPLOY_SSH_USER_INTERNAL@$DEPLOY_SSH_HOST_INTERNAL:/home/$DEPLOY_SSH_USER_INTERNAL/shogun --progress
    - rsync -avh --exclude '.git' shogun-gs-interceptor -e ssh $DEPLOY_SSH_USER_INTERNAL@$DEPLOY_SSH_HOST_INTERNAL:/home/$DEPLOY_SSH_USER_INTERNAL/shogun --progress
    - rsync -avh --exclude '.git' shogun-keycloak -e ssh $DEPLOY_SSH_USER_INTERNAL@$DEPLOY_SSH_HOST_INTERNAL:/home/$DEPLOY_SSH_USER_INTERNAL/shogun --progress
    - rsync -avh --exclude '.git' shogun-nginx/terrestris-dev/ -e ssh $DEPLOY_SSH_USER_INTERNAL@$DEPLOY_SSH_HOST_INTERNAL:/home/$DEPLOY_SSH_USER_INTERNAL/shogun-nginx/prod --progress  --mkpath
    - rsync -avh --exclude '.git' shogun-postgis -e ssh $DEPLOY_SSH_USER_INTERNAL@$DEPLOY_SSH_HOST_INTERNAL:/home/$DEPLOY_SSH_USER_INTERNAL/shogun --progress
    - rsync -avh --exclude '.git' shogun-print -e ssh $DEPLOY_SSH_USER_INTERNAL@$DEPLOY_SSH_HOST_INTERNAL:/home/$DEPLOY_SSH_USER_INTERNAL/shogun --progress
    - rsync -avh --exclude '.git' shogun-solr -e ssh $DEPLOY_SSH_USER_INTERNAL@$DEPLOY_SSH_HOST_INTERNAL:/home/$DEPLOY_SSH_USER_INTERNAL/shogun --progress
    - ssh $DEPLOY_SSH_USER_INTERNAL@$DEPLOY_SSH_HOST_INTERNAL docker compose --file /home/$DEPLOY_SSH_USER_INTERNAL/shogun/docker-compose.yml pull
    - ssh $DEPLOY_SSH_USER_INTERNAL@$DEPLOY_SSH_HOST_INTERNAL docker compose --file /home/$DEPLOY_SSH_USER_INTERNAL/shogun/docker-compose.yml up -d
